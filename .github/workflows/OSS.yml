name: Upload to Aliyun OSS

on:
  workflow_dispatch:

jobs:
  upload-to-oss:
    strategy:
      matrix:
        group: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v2
      with:
        repository: xxTree/ManifestAutoUpdate
        fetch-depth: 0

    - name: Setup ossutil
      run: |
        wget https://gosspublic.alicdn.com/ossutil/1.7.7/ossutil64
        chmod +x ossutil64
        sudo mv ossutil64 /usr/local/bin/ossutil

    - name: Upload to Aliyun OSS
      run: |
        ossutil config -e oss-cn-beijing.aliyuncs.com -i ${{ secrets.ALIID }} -k ${{ secrets.ALIKEY }}
        
        branches=($(git branch -a | grep -E 'remotes/origin/[0-9]+$' | sed 's/remotes\/origin\///'))
        total_branches=${#branches[@]}
        branches_per_group=$(( (total_branches + 19) / 20 ))

        for branch in "${branches[@]}"; do
          if (( (branch % 20) + 1 == group )); then
            git checkout $branch
            find . -type f ! -path "./.git/*" -print0 | while read -r -d $'\0' file; do
              ossutil cp "$file" "oss://zqb-client/zqb/branches/195270/$branch/$(basename "$file")" -f
            done
            echo "Uploaded branch $branch to Aliyun OSS: zqb/branches/195270/$branch"
          fi
        done
      env:
        group: ${{ matrix.group }}
